<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Painel de Pedidos</title>
    <link rel="icon" href="papudimlogo.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Quicksand", sans-serif;
        background-color: #fdfaf6;
      }
    </style>
  </head>
  <body class="min-h-screen px-4 py-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-md p-8">
      <div
        class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"
      >
        <div class="flex items-center gap-3">
          <img
            src="papudimlogo.png"
            alt="Logo"
            class="w-12 h-12 rounded-full"
          />
          <h1 class="text-2xl font-bold text-[#a47551]">Pedidos Recebidos</h1>
        </div>
        <div class="flex gap-2">
          <button
            onclick="exportarCSV()"
            class="bg-[#a47551] hover:bg-[#916546] text-white px-4 py-2 rounded-xl transition flex items-center gap-2"
          >
            ðŸ“¤ Exportar CSV
          </button>
          <button
            id="btnInsights"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl transition flex items-center gap-2"
            onclick="mostrarInsights()"
          >
            ðŸ“Š Ver Insights
          </button>
          <button
            onclick="logout()"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl transition flex items-center gap-2"
          >
            ðŸšª Sair
          </button>
        </div>
      </div>

      <div class="mb-4 flex flex-col sm:flex-row items-center gap-2">
        <label for="filtroStatus" class="font-semibold text-[#a47551]"
          >Filtrar por status:</label
        >
        <select
          id="filtroStatus"
          onchange="carregarPedidos()"
          class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#a47551]"
        >
          <option value="">Todos</option>
          <option value="pendente">Pendente</option>
          <option value="pago">Pago</option>
        </select>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-[#f3e8df] text-[#a47551]">
              <th class="py-2 px-3">Cliente</th>
              <th class="py-2 px-3">Total</th>
              <th class="py-2 px-3">Status</th>
              <th class="py-2 px-3">Itens</th>
              <th class="py-2 px-3">Data</th>
            </tr>
          </thead>
          <tbody id="tabelaPedidos"></tbody>
        </table>
      </div>
    </div>
    <div
      id="insights"
      class="mb-8 p-6 bg-[#f3e8df] rounded-xl shadow flex flex-col gap-2 text-[#5c3b1e] hidden"
    >
      <span class="font-bold text-lg">ðŸ“Š Insights do Papudim</span>
      <div id="insights-content" class="text-base"></div>
    </div>
    <footer class="mt-10 text-sm text-gray-500 text-center">
      &copy; 2025 Papudim
    </footer>
    <script>
      const token = localStorage.getItem("adminToken");
      if (!token) {
        alert("Acesso negado!");
        window.location.href = "/admin-login.html";
      }

      let todosPedidos = [];

      async function carregarPedidos() {
        const res = await fetch(
          "https://homepudimback.onrender.com/api/admin-pedidos",
          {
            headers: { Authorization: "Bearer " + token },
            credentials: "include",
          }
        );

        if (!res.ok) {
          alert("Token expirado ou invÃ¡lido.");
          localStorage.removeItem("adminToken");
          window.location.href = "/admin-login.html";
          return;
        }

        const pedidos = await res.json();
        todosPedidos = pedidos;

        const filtro = document.getElementById("filtroStatus").value;
        const filtrados = filtro
          ? pedidos.filter((p) => p.status === filtro)
          : pedidos;

        const tabela = document.getElementById("tabelaPedidos");
        tabela.innerHTML = "";

        filtrados.forEach((pedido) => {
          const linha = document.createElement("tr");
          const data = new Date(
            Number(pedido.id?.split("-")[1]) || 0
          ).toLocaleString("pt-BR");
          const itens = pedido.itens
            .map((i) => `${i.nome} x${i.quantidade}`)
            .join(", ");

          linha.innerHTML = `
            <td class="py-2 px-3">${pedido.cliente}</td>
            <td class="py-2 px-3">R$ ${pedido.total.toFixed(2)}</td>
            <td class="py-2 px-3">${pedido.status}</td>
            <td class="py-2 px-3">${itens}</td>
            <td class="py-2 px-3">${data}</td>
          `;
          tabela.appendChild(linha);
        });
      }

      function exportarCSV() {
        let csv = "Cliente,Total,Status,Itens,Data\n";
        todosPedidos.forEach((pedido) => {
          const data = new Date(
            Number(pedido.id?.split("-")[1]) || 0
          ).toLocaleString("pt-BR");
          const itens = pedido.itens
            .map((i) => `${i.nome} x${i.quantidade}`)
            .join(" / ");
          csv += `${pedido.cliente},${pedido.total},${pedido.status},"${itens}",${data}\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "pedidos_papudim.csv";
        link.click();
      }

      function logout() {
        localStorage.removeItem("adminToken");
        window.location.href = "/admin-login.html";
      }

      function mostrarInsights() {
        const insightsDiv = document.getElementById("insights");
        insightsDiv.classList.remove("hidden");
        carregarInsights();
        // Opcional: desabilitar o botÃ£o apÃ³s clicar
        document.getElementById("btnInsights").disabled = true;
        document.getElementById("btnInsights").classList.add("opacity-50", "cursor-not-allowed");
      }

      async function carregarInsights() {
        try {
          // Troque a URL abaixo para o endereÃ§o pÃºblico do seu Flask!
          const res = await fetch(
            "https://relatoriospudim.onrender.com/api/insights"
          );
          const data = await res.json();
          let html = `<b>Faturamento total:</b> R$ ${data.faturamento_total.toFixed(
            2
          )}<br>`;
          html += "<b>Top Sabores:</b><ul>";
          data.top_sabores.forEach(
            (s) => (html += `<li>${s.sabor}: ${s.quantidade} unidades</li>`)
          );
          html += "</ul>";
          html += "<b>Faturamento por data:</b><ul>";
          data.timeline.forEach(
            (t) =>
              (html += `<li>${t.data}: R$ ${t.faturamento.toFixed(2)}</li>`)
          );
          html += "</ul>";
          document.getElementById("insights-content").innerHTML = html;
        } catch (e) {
          document.getElementById("insights-content").innerText =
            "Erro ao carregar insights.";
        }
      }

      carregarPedidos();
    </script>
  </body>
</html>
